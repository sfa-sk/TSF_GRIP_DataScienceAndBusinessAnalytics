"use strict";
this.parseTimeMarkers = this.parseTimeMarkers || {};
var marker = this.parseTimeMarkers['textboxVisual.min.js'] || (this.parseTimeMarkers['textboxVisual.min.js'] = {});
marker.startEval = window.jsCommon && window.jsCommon.performance && window.jsCommon.performance.now ? window.jsCommon.performance.now() : Date.now(); marker.isExternal = false;
if (window.perfTracking && window.perfTracking.startBundleEval) window.perfTracking.startBundleEval('textboxVisual.min.js');var es6,powerbi,__extends=this&&this.__extends||function(){var o=function(t,e){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])})(t,e)};return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function i(){this.constructor=t}o(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}}(),__assign=this&&this.__assign||function(){return(__assign=Object.assign||function(t){for(var e,i=1,o=arguments.length;i<o;i++)for(var n in e=arguments[i])Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t}).apply(this,arguments)},__spreadArray=this&&this.__spreadArray||function(t,e){for(var i=0,o=e.length,n=t.length;i<o;i++,n++)t[n]=e[i];return t};!function(l){var u,t,p;function s(t,e){return l.isValueRef(t)?i(t.selector.id,e):t}function i(t,e){e=null==e?void 0:e[t];return null==e?void 0:e.formattedValue}function c(t){return _.isDate(t)?7:_.isInteger(t)?4:_.isNumber(t)?3:_.isBoolean(t)?5:_.isString(t)?1:0}u=l.visuals||(l.visuals={}),t=u.TextEvaluation||(u.TextEvaluation={}),p=l.visuals.valueFormatter.VariantValueFormatter,t.combineEvaluatedTextRuns=function(t,e){for(var i=[],o=0,n=t;o<n.length;o++){var r=s(n[o].value,e);r&&i.push(r)}return i.join("")},t.evaluateTextRunConditional=function(t,e){var i;return i=l.isValueRef(t.expression)?(i=t.expression.selector.id,null==(e=null==e?void 0:e[i])?void 0:e.value):t.expression,u.ConditionalEvaluator.processCases(t,i).textRuns},t.getTextRunValue=s,t.getTextRunValueFormatted=i,t.isTextRun=function(t){return _.isString(t.value)||l.isValueRef(t.value)},t.isAtMentionTextRun=function(t){return!_.isNil(t.mentionEmail)},t.isTextRunConditional=function(t){return _.isArray(t.cases)&&!!t.defaultCase&&_.isArray(t.defaultCase.textRuns)&&(l.isValueRef(t.expression)||_.isString(t.expression)||_.isNumber(t.expression)||_.isBoolean(t.expression)||_.isDate(t.expression))},t.populateEvaluatedValues=function(t,e,i){var o=u.textboxProps.values.expr.objectName,n=(u.textboxProps.values.formatString.objectName,l.DataViewObjects.getUserDefinedObjects(t,o));if(!_.isEmpty(n)){for(var r in n){var s=l.DataViewObject.getValue(n[r],u.textboxProps.values.expr.propertyName),a=new p({column:{displayName:"",objects:n,type:l.ValueType.fromPrimitiveTypeAndCategory(c(s))},formatStringPropId:{objectName:r,propertyName:u.textboxProps.values.formatString.propertyName},nullsAreBlank:!1});e[r]={value:s,formattedValue:a.format(s)}}i&&i.trace(2,"TextboxWithSmartNarrativeValuesDataChanged")}},t.primitiveTypeFromPrimitiveValue=c}(powerbi=powerbi||{}),function(t){var T,F,e,o,a,f,E,i,s,m,l,n,r,g,N,v,w,u,p,c,h,d,y,S,C,x,b;function A(t){t&&(this.supportsNarrativeExpressions=!1!==t.supportsNarrativeExpressions,this.supportsAtMention=!!t.supportsAtMention,this.textChangeThrottle=t.textChangeThrottle,this.placeholderText=t.placeholderText,this.supportsFormattingChangeIndicationOptions=!!t.supportsFormattingChangeIndication,t.textChangeThrottle&&this.supportsNarrativeExpressions,this.fontFamilies=__spreadArray([],t.allowedFonts||F.Fonts||[]),this.fontSizes=__spreadArray([],t.allowedFontSizes||F.FontSizes||[]),this.restrictFontSizes=_.some(t.allowedFontSizes),t.viewModelAdapter&&(this.viewModelAdapter=t.viewModelAdapter),this.disableScrollingInViewMode=t.disableScrollingInViewMode,this.featureSwitches=t.featureSwitches)}function V(t,e){var i,o;return t&&(i=z(t)),e[E.QuillWrapper.atMentionBlotClass.class]&&!0!==e[E.QuillWrapper.atMentionBlotClass.class]&&(o={mentionEmail:(t=e[E.QuillWrapper.atMentionBlotClass.class]).email,value:null!=(e=t.displayName)?e:t.email},i&&(o.textStyle=i)),o}function O(t,e){var i,o;if(t&&((n=z(t))&&(i=n),void 0!==t.link&&P(t.link)&&(o=t.link)),e[E.QuillWrapper.smartNarrativesBlotClass.class]&&!0!==e[E.QuillWrapper.smartNarrativesBlotClass.class]){var n=(r=e[E.QuillWrapper.smartNarrativesBlotClass.class]).objRef;if(!n)return;if(n===E.QuillPlaceholder)return;s={textStyle:i,url:o,value:{propertyIdentifier:T.textboxProps.values.expr,selector:{id:n}}}}else if(e[E.QuillWrapper.smartNarrativesConditionalBlotClass.class]&&!0!==e[E.QuillWrapper.smartNarrativesConditionalBlotClass.class]){var r=e[E.QuillWrapper.smartNarrativesConditionalBlotClass.class];if(!T.TextEvaluation.isTextRunConditional(r.definition))return;for(var s,a=0,l=(s=r.definition).cases;a<l.length;a++)for(var u=0,p=l[a].textRuns;u<p.length;u++)(c=p[u]).textStyle=i,c.url=o;for(var c,h=0,d=s.defaultCase.textRuns;h<d.length;h++)(c=d[h]).textStyle=i,c.url=o}return s}function P(t){if(_.isEmpty(t))return!1;switch(p.getUrlScheme(t)){case u.http:case u.https:case u.mailto:return!0;default:return!1}}function z(t){var e,i={};return t.bold&&(i.fontWeight="bold"),t.font&&(e=T.Font.normalizeFamily(_.unescape(t.font),!1),e=F.getFontFromCSS(e),i.fontFamily=e),t.italic&&(i.fontStyle="italic"),t.size&&(i.fontSize=t.size),t.underline&&(i.textDecoration="underline"),t.color&&(i.color=t.color),t.script&&(i.lineHeight="0",i.position="relative",i.verticalAlign="baseline",i.scriptType=t.script,t.script===F.TextScriptTypes.Sub.toLowerCase()?i.bottom="-0.25em":i.top="-0.25em"),i}function R(t,e,i,o,n,r,s,a,l){var u=this;this.readOnly=t,this.host=e,this.style=i,this.options=o,this.supportsAtMention=n,this.$mentionsHoverContainer=r,this.personCardComponent=s,this.placeholderText=a,this.supportsFormattingChangeIndication=l,this.textChanged=_.noop,this.$container=$("<div>"),this.localizationProvider={get:function(t){return u.host.getLocalizedString(t)},getOptional:function(t){return u.host.getLocalizedString(t)},format:function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];return u.host.getLocalizedString(t,e)}},this.quillReady=this.host.promiseFactory().defer(),T.TextboxUtil.getLoadQuillResources()?(this.initialized=!1,this.dependenciesLoaded=this.host.loader().require({javascript:"quill",css:["quill.core"]}).then(function(t){return u.initializeQuill(t)})):(this.initializeQuill(window.Quill),this.dependenciesLoaded=this.host.promiseFactory().resolve())}function B(t,e,i,o){this.quillWrapper=t,this.localizationProvider=e,this.linkInput=i,this.featureSwitches=o.featureSwitches,this.updateOptions(o);var t=B.ColorPicker.buildFontColorButtons(e.get("Visual_FontColor"),e.get("Visual_FontColor_Picker")),i=this.container=C.div().addClass("toolbar").addClass("themeableElement").attr("aria-label",C.getTooltip("FontControl",e)).attr("focus-nav-mode","Group"),n=C.formatGroup(),t=(1<_.size(this.fontFamilies)&&n.append(this.fontFamilyPicker),1<_.size(this.fontSizes)&&n.append(this.fontSizePicker),n.append(t),C.div().addClass("toolbar-content").append(n).append(C.formatGroup().append(C.formatButton(C.getTooltip("Bold",e),"bold")).append(C.formatButton(C.getTooltip("Italic",e),"italic",null,"italic",!0)).append(C.formatButton(C.getTooltip("Underline",e),"underline"))).append(C.formatGroup().append(this.textAlignmentGroup)).append(C.formatGroup().append(C.formatButton(C.getTooltip("Link",e),"link")).append(this.linkInput))),r=(this.featureSwitches&&this.featureSwitches.textboxSuperSubScriptBulletedList&&t.append(C.formatGroup().append(this.textScriptGroup)).append(C.formatGroup().append(C.formatButton(C.getTooltip("BulletedList",e),"list","bullet","bulletedlist",!0))),i.append(t),o.supportsNarrativeExpressions&&(t.addClass("fixed-size"),i.append(C.smartNarrativesEditor())),o.supportsFormattingChangeIndication&&!this.quillWrapper.readOnly&&i.append(C.formattingSettingsGroup()),this.featureSwitches&&this.featureSwitches.textboxSuperSubScriptBulletedList&&t.css("width","645px"),this.onEscape);r&&i.on("keydown",function(t){27===t.keyCode&&(t.stopPropagation(),t.preventDefault(),r())})}function k(){return $("<div>")}function I(){return $("<span>")}function L(){return $("<button>")}function U(t,e,i,o){return $("<select>").attr("title",t).attr("aria-label",t).append(q(e,i,o))}function W(t,e,i,o){return t.empty().append(q(e,i,o))}function q(t,i,o){return _.map(t,function(t){var e=$("<option>").text(t.label);return t.value===i?e.attr("selected","selected"):e.attr("value",t.value),e=void 0!==o?o(e,t):e})}function j(t,e,i,o,n){var r=L();return null!=t&&r.attr("title",t).attr("aria-label",t),null!=e&&r.addClass("ql-"+e),null!=i&&r.attr("value",i),null==o&&(null!=e&&(o=e),null!=i&&(o=(o||"")+i)),null!=o&&n?(r.addClass("pbi-glyph-"+o),r.addClass(e),r.css("font-family","PowrMDL2")):r.addClass("powervisuals-glyph "+o),r}function M(t,e){return e.get("RichTextbox_"+t+"_ToolTip")}T=t.visuals||(t.visuals={}),i=jsCommon.Color,s=jsCommon.CssConstants.createClassAndSelector,m=jsCommon.DOMConstants,l=jsCommon.FocusManager,n=jsCommon.FocusManagerFocusEventName,r=jsCommon.FocusNavModeAttribute,g=T.Units.FontSize,N=t.isValueRef,v=jsCommon.KeyUtils,w=jsCommon.StringExtensions,u=jsCommon.UrlUtils.UrlScheme,p=jsCommon.UrlUtils,T.mentionDefaultMaxSearchLength=48,c=s("textboxFocusElement"),h={linkTooltip:s("ql-link-tooltip"),toolbarUrlInput:s("toolbar-url-input")},(t=F=T.TextboxFormatting||(T.TextboxFormatting={})).Fonts=["Arial","Arial Black","Arial Unicode MS","Calibri","Cambria","Cambria Math","Candara","Comic Sans MS","Consolas","Constantia","Corbel","Courier New","Georgia","Lucida Sans Unicode","Segoe (Bold)","Segoe UI","Segoe UI Light","Symbol","Tahoma","Times New Roman","Trebuchet MS","Verdana","Wingdings"],t.FontSizePrecision=1,t.FontSizes=[8,9,10,10.5,11,12,14,16,18,20,24,28,32,36,40,42,44,54,60,66,72,80,88,96],t.LegacyDefaultFont=T.Font.Family.light.family,t.LegacyFontSize=g.createFromPx(14),t.LegacyDefaultFontProperties={family:t.LegacyDefaultFont,size:t.LegacyFontSize},t.TextAlignments=["Left","Center","Right"],t.DefaultAlignment="Left",(e=t.TextScriptTypes||(t.TextScriptTypes={})).Super="Super",e.Sub="Sub",(t.TextListTypes||(t.TextListTypes={})).Bullet="bullet",t.getCSSFromFont=function(t){var e=T.Font.FamilyMap[t];return e?e.family:t},t.getFontFromCSS=function(e){return _.findKey(T.Font.FamilyMap,function(t){return t.family===e||0<t.family.indexOf(e)})||e},A.prototype.init=function(t){this.element=t.element,this.host=t.host,this.viewport=t.viewport,this.style=t.style,this.readOnly=0===this.host.getViewMode(),this.paragraphs=[],this.defaultFont=__assign({},F.LegacyDefaultFontProperties),this.fontFamilies=__spreadArray([],this.fontFamilies||F.Fonts||[]),this.fontSizes=__spreadArray([],this.fontSizes||F.FontSizes||[]),this.evaluatedValues={},this.quillEditorIsReady=this.host.promiseFactory().defer(),this.featureSwitches=t.featureSwitches,this.configureMentions(),this.refreshView()},A.prototype.onResizing=function(t){var e=this.viewport;this.viewport=t,this.updateSize(),this.viewModelAdapter&&this.viewModelAdapter.onResizing(this.element,this.viewport,e,this.defaultFont)},A.prototype.onDataChanged=function(t){var e,t=t.dataViews;this.evaluatedValues={},this.paragraphs=[],t&&0<t.length&&((t=t[0].metadata.objects)&&t.general&&(this.paragraphs=t.general.paragraphs),T.TextEvaluation.populateEvaluatedValues(t,this.evaluatedValues,this.host.telemetry()),e=T.ColorHelper.create(this.style),this.defaultFont=T.FontProperties.createFromObjectOrStyle(t&&t.text,{family:"fontFamily",size:"fontSize",color:"color"},e,this.style,"foreground","label",F.LegacyDefaultFontProperties)),this.mergeParagraphFontsWithStandardFonts(),this.refreshView()},A.prototype.getTelemetryInformation=function(){for(var t,e=!1,i=[],o=0,n=this.paragraphs;o<n.length;o++)for(var r=0,s=n[o].textRuns;r<s.length;r++){var a,l=s[r];T.TextEvaluation.isTextRunConditional(l)?(e=!0,_.isEmpty(l.cases)||(a=_.first(l.cases),i.push(_.round(a.pattern,-2)))):T.TextEvaluation.isTextRun(l)&&N(l.value)&&(e=!0)}return e&&((t={SmartNarratives:!0}).SummarizationTemplateIds=i.join(","),t=t),t},A.prototype.mergeParagraphFontsWithStandardFonts=function(){var t=__spreadArray(__spreadArray([],_.map(this.fontSizes,function(t){return g.createFromPt(t)})),[this.defaultFont.size]),e=_.chain(t).map(function(t){return t.pt}).uniqBy(function(t){return t}).sortBy(function(t){return t}).value(),i=F.getFontFromCSS(this.defaultFont.family),o=__spreadArray(__spreadArray([],this.fontFamilies),[i]),i=this.paragraphs;if(i)for(var n=0,r=i;n<r.length;n++){var s=r[n];if(s.textRuns)for(var a=0,l=s.textRuns;a<l.length;a++){var u,p,c=l[a],c=c&&T.TextEvaluation.isTextRun(c)&&c.textStyle;c&&(c.fontSize&&(u=g.createFromCSS(c.fontSize,F.FontSizePrecision))&&(this.restrictFontSizes?(p=_.sortedIndex(e,u.pt),c.fontSize=e[Math.min(p,e.length-1)]+"pt"):t.push(u)),c.fontFamily&&o.push(c.fontFamily))}}this.fontSizes=_.chain(t).map(function(t){return t.pt}).sortBy(function(t){return t}).uniqBy(function(t){return t}).value(),this.fontFamilies=_.chain(o).sortBy(function(t){return t}).uniqBy(function(t){return t}).value()},A.prototype.destroy=function(){this.editor&&(this.editor.destroy(),this.editor=void 0)},A.prototype.focus=function(){if(this.editor)return this.editor.focus(),!0},A.prototype.onViewModeChanged=function(t){this.readOnly=0===t,this.refreshView()},A.prototype.setSelection=function(t,e){this.editor,this.editor&&this.editor.setSelection(t,e)},A.prototype.getSelection=function(){return this.editor.getSelection()},A.prototype.ensureFocusableElement=function(){var t,e=this,i=this.element;i.find(c.selector).length||(t=$("<div>").width(0).height(0).attr("tabindex",0).addClass(c.class),i.append(t),t.on(n,function(){e.focus()}))},A.prototype.removeFocusableElement=function(){this.element.find(c.selector).remove()},A.prototype.refreshView=function(){var t,e,i=this;this.readOnly?(this.editor&&(this.saveContents(),this.editor.destroy(),this.editor=null),this.element.empty(),e=a.convertParagraphsToHtml(this.paragraphs,this.defaultFont,this.evaluatedValues,this.$mentionsHoverContainer,this.personCardComponent),e=$("<div>").addClass(A.ClassAndSelector.class).css(T.FontProperties.toHTMLStyle(this.defaultFont)).append(e),this.supportsAtMention&&e.append(this.$mentionsHoverContainer),t=void(this.viewModelAdapter&&this.viewModelAdapter.onDataChanged(e,this.viewport,this.defaultFont)),this.disableScrollingInViewMode?this.element.append(t=e):(t=this.$scrollableDiv=$("<div></div>").addClass(A.ScrollWrapperClassAndSelector.class).css({height:this.viewport.height+"px","overflow-y":"auto","overflow-x":"hidden"}).append(e),this.element.append(this.$scrollableDiv)),this.removeFocusableElement(),t.attr("tabindex",0).attr("role","document").attr(r,"Browser").on("keydown",function(t){27===t.keyCode&&null!=(t=i.$scrollableDiv)&&t.removeAttr(r).removeAttr("tabindex")}).focusout(function(){var t;null!=(t=i.$scrollableDiv)&&t.attr("tabindex",0).attr(r,"Browser")})):(e={defaultFont:this.defaultFont,evaluatedValues:this.evaluatedValues,fontFamilies:this.fontFamilies,fontSizes:this.fontSizes,supportsNarrativeExpressions:this.supportsNarrativeExpressions,textChangeThrottle:this.textChangeThrottle,onEscape:function(){return i.focus()},featureSwitches:this.featureSwitches,supportsFormattingChangeIndication:this.supportsFormattingChangeIndicationOptions},t=this.supportsFormattingChangeIndicationOptions&&!this.readOnly,this.editor?this.editor.updateOptions(e):(this.editor=new E.QuillWrapper(this.readOnly,this.host,this.style,e,this.supportsAtMention,this.$mentionsHoverContainer,this.personCardComponent,this.placeholderText,t),this.editor.textChanged=function(){return i.saveContents()},this.element.empty(),this.ensureFocusableElement(),(e=this.editor.getElement()).addClass(A.ClassAndSelector.class),this.element.append(e)),this.editor.getElement().css(T.FontProperties.toHTMLStyle(this.defaultFont)),this.editor.quillReady.promise.then(function(){i.quillEditorIsReady.resolve(),i.restrictFontSizes&&(i.editor.onPaste=function(){i.mergeParagraphFontsWithStandardFonts(),i.refreshView()});var t=i.editor.getSelection(),e=a.convertParagraphsToOps(i.paragraphs,i.evaluatedValues,i.editor,i.style,i.$mentionsHoverContainer,i.personCardComponent);i.editor.setContents(e),t&&i.editor.setSelection(t.index,t.length)})),this.updateSize()},A.prototype.saveContents=function(){var t;!this.editor||(t=this.editor.getContents())&&(this.paragraphs=a.convertDeltaToParagraphs(t,this.supportsNarrativeExpressions,this.evaluatedValues),t=[{objectName:"general",properties:{paragraphs:this.paragraphs},selector:null}],this.host.persistProperties(t))},A.prototype.updateSize=function(){this.editor?this.editor.resize(this.viewport):this.$scrollableDiv&&this.$scrollableDiv.css("height",this.viewport.height+"px")},A.prototype.configureMentions=function(){this.supportsAtMention&&(this.$mentionsHoverContainer=$("<span>").addClass(A.MentionsHoverClassAndSelector.class).hide(),this.personCardComponent=this.host.getUIComponentFactory().createPersonCard(this.$mentionsHoverContainer.get(0)))},A.prototype.onTextEditorReady=function(){return this.quillEditorIsReady.promise},A.ClassAndSelector=jsCommon.CssConstants.createClassAndSelector("textbox"),A.MentionsHoverClassAndSelector=s("mentions-hover"),A.ScrollWrapperClassAndSelector=jsCommon.CssConstants.createClassAndSelector("scrollWrapper"),d=A,T.Textbox=d,function(t){s.prototype.onResizing=function(t,e,i,o){i=this.isSmallViewport(i),e=this.isSmallViewport(e);i!==e&&this.applyScaleOnElement(t,e,o)},s.prototype.onDataChanged=function(t,e,i){this.isSmallViewport(e)&&this.applyScaleOnElement(t,!0,i)},s.prototype.isSmallViewport=function(t){return!!t&&!!this.smallViewportProperties&&(t.height<=this.smallViewportProperties.minHeightToScaleFontSize||t.width<=this.smallViewportProperties.minWidthToScaleFontSize)},s.prototype.applyScaleOnElement=function(t,n,r){n&&(r=__assign(__assign({},r),{size:s.scale(r.size)})),t.find(d.ClassAndSelector.selector).css(T.FontProperties.toHTMLStyle(r)),t.find(a.TextRunElement.selector).each(function(t,e){n?(o=void 0,o=(i=$(e).css("font-size"))?g.createFromCSS(i):r.size,i=s.scale(o)):(o=(o=$(e).data(a.ModelKeyName)).textStyle&&o.textStyle.fontSize)&&(i=g.createFromCSS(o));var i,o=r;i&&(o=__assign(__assign({},r),{size:i})),T.FontProperties.applyStyleToElement(o,e)})},s.scale=function(t){t=t.px,t=66<t?32:42<t?28:26<t?24:16<t?20:11<t?14:12;return g.createFromPx(t)};var e=s;function s(t){this.smallViewportProperties=t}t.ViewModelAdapter=e;__extends(o,i=e);var i,e=o;function o(){return i.call(this,{minHeightToScaleFontSize:1/0,minWidthToScaleFontSize:1/0})||this}function n(){}t.AlwaysUseSmallViewport=e,n.format=function(t){return/^\S+@\S+\.\S+$/.test(t)?"mailto:"+t:/^https?:\/\//i.test(t)?t:"https://"+t},t.LinkPreview=n}(o=T.TextboxHelpers||(T.TextboxHelpers={})),(f=a=T.RichTextConversion||(T.RichTextConversion={})).ModelKeyName="ModelObject",f.TextRunElement=jsCommon.CssConstants.createClassAndSelector("textRun"),f.convertDeltaToParagraphs=function(t,e,i){for(var o,n=[],r={textRuns:[]},s=!1,a=0,l=t.ops.length;a<l;a++){var u=t.ops[a],p=u.attributes,u=u.insert;if(void 0!==u)if(_.isString(u)){var c,h=u,s=!1,d=(p&&p.align&&(void 0!==r.horizontalTextAlignment&&(r.horizontalTextAlignment,p.align),r.horizontalTextAlignment=p.align),p&&p.list&&(r.listType=p.list),0),f=0,m=void 0;do{}while((f=h.indexOf(T.TextRunNewline,d))<0?(m=!1,f=h.length):m=!0,0<f-d&&(g={value:h.substring(d,f)},p&&(void 0!==p.link&&P(p.link)&&(g.url=p.link),(c=z(p))&&(g.textStyle=c)),r.textRuns.push(g)),m&&(0===r.textRuns.length&&r.textRuns.push({value:""}),n.push(r),r={textRuns:[]}),(d=f+1)<h.length)}else if(!_.isNumber(u)){var g,v=V(p,u);if(v)r.textRuns.push(v);else if(e)if(g=O(p,u)){if(T.TextEvaluation.isTextRunConditional(g)){v=T.TextEvaluation.evaluateTextRunConditional(g,i),u=T.TextEvaluation.combineEvaluatedTextRuns(v,i);if((u===T.TextRunNewline||u===T.TextRunNewlineHidden)&&!s){0===r.textRuns.length&&r.textRuns.push({value:""}),n.push(r),s=!(r={textRuns:[]});continue}s=!0}r.textRuns.push(g)}}}return 0<r.textRuns.length&&(o=_.first(r.textRuns),T.TextEvaluation.isTextRun(o)&&_.isString(o.value)&&0<o.value.length&&n.push(r)),n},f.convertParagraphsToHtml=function(t,a,l,u,p){for(var e=$(),i=0,o=t.length;i<o;++i){for(var c=t[i],h=!0,d=$("<p>").data(f.ModelKeyName,c),n=(c.horizontalTextAlignment&&d.css("text-align",c.horizontalTextAlignment),0),r=c.textRuns.length;n<r;++n)!function(t){var i,t=c.textRuns[t],e=void 0,o=void 0,n=void 0;if(T.TextEvaluation.isTextRun(t))e=t.value,o=t.textStyle,n=t.url,T.TextEvaluation.isAtMentionTextRun(t)&&(e="@"+e,(o=o||{}).color="#1453b3",i=t.mentionEmail);else{if(!T.TextEvaluation.isTextRunConditional(t))return;var r=T.TextEvaluation.evaluateTextRunConditional(t,l);if((e=T.TextEvaluation.combineEvaluatedTextRuns(r,l))===T.TextRunNewlineHidden)return;_.isEmpty(r)||(o=r[0].textStyle,n=r[0].url)}_.isEmpty(e)||(h=!1);var s=void 0!==n&&P(n)?$("<a>").attr("href",n).attr("rel","noopener noreferrer").attr("target","_blank"):$("<span>"),r=T.TextEvaluation.getTextRunValue(e,l),n=(s.text(r).addClass(f.TextRunElement.class).data(f.ModelKeyName,t),o);n&&(e={},n.fontFamily&&(e["font-family"]=E.getCssFontFamily(n.fontFamily,a)),n.fontSize&&(r=g.createFromCSS(n.fontSize),e["font-size"]=E.getCssFontSize(r,a)),n.fontStyle&&(e["font-style"]=n.fontStyle),n.fontWeight&&(e["font-weight"]=n.fontWeight),n.color&&(e.color=n.color),n.textDecoration&&(e["text-decoration"]=n.textDecoration),n.scriptType&&(e.lineHeight=n.lineHeight,e.position=n.position,e.verticalAlign=n.verticalAlign,n.scriptType===F.TextScriptTypes.Sub.toLowerCase()?e.bottom=n.bottom:e.top=n.top),s.css(e)),i&&s.on(m.pointerOverEventName,function(){p.showUser(i);var t=s.get(0),e=t.getBoundingClientRect();u.stop(!0,!0).css({left:t.offsetLeft,top:t.offsetTop-e.height-32}).delay(200).queue(function(t){s.is(":hover")&&u.fadeIn("fast"),t()})}).on(m.pointerOutEventName,function(){u.delay(500).queue(function(t){var e=function(t){u.is(":hover")?setTimeout(function(){return e(t)},500):t()};e(t)}).fadeOut("fast")}),d.append(s)}(n);c.listType===F.TextListTypes.Bullet&&(d.css("display","inline"),(d=d.wrap("<ul><li></li></ul>").parent().parent()).css("text-align",c.horizontalTextAlignment)),h&&d.append($("<br>")),e=e.add(d)}return e},f.convertParagraphsToOps=function(t,e,i,o,n,r){for(var s=[],a=0,l=0,u=t.length;l<u;++l){for(var p=t[l],c=0,h=p.textRuns.length;c<h;++c){var d=p.textRuns[c],f=void 0,m=void 0,g=void 0;if(T.TextEvaluation.isTextRun(d))f=d.textStyle,m=d.url,g=d.value;else{if(!T.TextEvaluation.isTextRunConditional(d))continue;_.isEmpty(d.cases)||(S=_.first(d.cases),_.isEmpty(S.textRuns)||(f=_.first(S.textRuns).textStyle,m=_.first(S.textRuns).url))}var v,y,S={},C=(f&&(f.fontFamily&&(S.font=T.Font.normalizeFamily(F.getCSSFromFont((C=f.fontFamily,!_.startsWith(C,"'")||w.containsIgnoreCase(C,",")?C:(_.endsWith(C,"'"),C.slice(1,C.length-1)))))),f.fontSize&&(S.size=f.fontSize),f.color&&(S.color=f.color),S.italic="italic"===f.fontStyle||void 0,S.bold="bold"===f.fontWeight||void 0,S.underline="underline"===f.textDecoration||void 0,f.scriptType&&(S.script=f.scriptType)),g),f=(m&&P(m)&&(S.link=m),void 0);f=N(C)?(v=C.selector.id,y={definition:d,destroyEditorActions:i.destroyEditorActions,evaluatedValues:e,localizationProvider:i.localizationProvider,objRef:v,onSelectSmartNarrativesBlot:function(t){var e;null!=(e=null==i?void 0:i.smartNarrativesEditorContainer)&&e.getSmartNarrativesEditor().onSelectEditableObject(t)},style:o},{attributes:S,insert:((g={})[E.QuillWrapper.smartNarrativesBlotClass.class]=y,g)}):T.TextEvaluation.isTextRunConditional(d)?(v=N(d.expression)?d.expression.selector.id:void 0,y={conditionalIndex:a,definition:d,destroyEditorActions:i.destroyEditorActions,evaluatedValues:e,localizationProvider:i.localizationProvider,objRef:v,onSelectSmartNarrativesBlot:function(t){var e;null!=(e=null==i?void 0:i.smartNarrativesEditorContainer)&&e.getSmartNarrativesEditor().onSelectEditableObject(t)},onSelectSmartNarrativesConditionalBlot:function(t){setTimeout(function(){null!=i&&i.setSelectionOfConditional(t)})},style:o},a++,{attributes:S,insert:((m={})[E.QuillWrapper.smartNarrativesConditionalBlotClass.class]=y,m)}):T.TextEvaluation.isAtMentionTextRun(d)?(y={email:d.mentionEmail,displayName:C,hoverContainer:n,personCardComponent:r},{attributes:S,insert:((g={})[E.QuillWrapper.atMentionBlotClass.class]=y,g)}):{attributes:S,insert:C},s.push(f)}var x={insert:"\n"},b=(_.endsWith(_.last(s).insert,"\n"),function(t){var e={};t.horizontalTextAlignment&&(e.align=t.horizontalTextAlignment);t.listType&&(e.list=t.listType);return!_.isEmpty(e)&&e}(p));b&&(x.attributes=b),s.push(x)}return s},f.getAtMentionTextRun=V,f.getTextRunFromSmartNarrativesInsert=O,f.isValidLinkUrl=P,(y=E=T.RichText||(T.RichText={})).getCssFontFamily=function(t,e){return(t=F.getCSSFromFont(t))!==e.family?t:void 0},y.getCssFontSize=function(t,e){return null==t||t.equals(e.size)?"":t.pt+"pt"},y.QuillPlaceholder="__Placeholder__",y.getCustomQuillFormatValue=function(t,e){var i;return i=void 0===t||_.isString(t.insert)||_.isNumber(t.insert)||void 0===t.insert?i:t.insert[e]},R.getFormatPath=function(t){return R.quillFormatsPath+"/"+t},R.prototype.updateOptions=function(t){var e,i=this;this.initialized?(this.options=t,(e=this.toolbar)&&e.updateOptions(t),this.smartNarrativesEditorContainer&&this.smartNarrativesEditorContainer.updateOptions(t)):this.dependenciesLoaded.then(function(){return i.updateOptions(t)})},R.prototype.initializeQuill=function(t){this.quillStatic=t,this.rebuildQuillEditor(),this.initialized=!0,this.quillReady.resolve(),this.quillStatic.debug("error")},R.prototype.getElement=function(){return this.$container},R.prototype.getContents=function(){if(this.initialized)return this.editor.getContents()},R.prototype.setContents=function(t){this.initialized,this.editor&&this.editor.setContents(t)},R.prototype.resize=function(t){this.$container.width(t.width),this.$container.height(t.height),this.updateToolbar()},R.prototype.setReadOnly=function(t){var e=t!==this.readOnly;this.readOnly=t,this.initialized&&e&&this.rebuildQuillEditor()},R.prototype.setSelection=function(t,e){this.editor&&this.editor.setSelection(t,e)},R.prototype.getSelection=function(t){if(this.editor)return this.editor.getSelection(t)},R.prototype.focus=function(){this.editor&&0===$(document.activeElement).closest(this.$container).length&&this.editor.focus()},R.prototype.destroy=function(){this.host.setToolbar(null),this.toolbar=null,this.$container.remove(),this.$container=null,this.destroyEditor()},R.prototype.destroyEditor=function(){this.editor&&(_.isEmpty(this.destroyEditorActions)||(_.forEach(this.destroyEditorActions,function(t){return t()}),this.destroyEditorActions=void 0),this.editor=null)},R.prototype.getSelectionAtCursor=function(){var t=this.getTextWithoutTrailingBreak(),e=this.getSelection(!0);return e&&0===e.length?{index:(t=jsCommon.WordBreaker.find(e.index,t)).start,length:t.end-t.start}:e},R.prototype.getWord=function(){var t=this.getSelectionAtCursor();return this.getTextWithoutTrailingBreak().slice(t.index,t.index+t.length)},R.prototype.getEditorContainer=function(){if(this.editor)return $(this.editor.container)},R.prototype.setSelectionOfConditional=function(t){var e=this.getContents();if(e)for(var i=0,o=0,n=e.ops;o<n.length;o++){var r=n[o];if(!r)return;if(_.isString(r.insert))i+=r.insert.length;else if(_.isNumber(r.insert))i+=1;else{i+=1;r=y.getCustomQuillFormatValue(r,y.QuillWrapper.smartNarrativesConditionalBlotClass.class);if((null==r?void 0:r.conditionalIndex)===t){this.setSelection(i,0);break}}}},R.computeTransparentSmartNarrativesColor=function(t){t=i.parseColorString(t);return t.A=R.smartNarrativesPlaceholderOpacity,i.rgbString(t)},R.prototype.getTextWithoutTrailingBreak=function(){return this.editor.getText().slice(0,-1)},R.prototype.rebuildQuillEditor=function(){function t(t){if(t=t.relatedTarget||document.activeElement){if(a.targetIsInToolbar(t,u))return;if((u||a.supportsFormattingChangeIndication)&&a.saveState(),R.willBrowserHandleFocus(t))return}a.setSelection(null,null)}var o,e,i,n,r,s,a=this,l=null,u=this.options.supportsNarrativeExpressions,p=(this.editor&&(l=this.editor.getContents()),this.$container.empty(),this.$container.keydown(function(t){var e=t.which;t.ctrlKey&&v.isCtrlShortcutKey(e)&&t.stopPropagation(),(v.isArrowKey(e)||v.isNudgeModifierKey(e))&&t.stopPropagation(),v.isDeleteKey(e)&&t.stopPropagation(),jsCommon.BrowserUtils.isCtrlOrMeta(t)&&117===t.keyCode&&(a.focusToolbar(),t.stopPropagation())}),$("<div>")),c={readOnly:this.readOnly,formats:["bold","italic","underline","font","size","link","align","color","script","list"],modules:{history:{userOnly:!0},keyboard:{bindings:{}}},placeholder:this.placeholderText},h=[],d=(this.supportsAtMention&&(this.setupAtMentionFormat(),o=$("<div>"),h.push({mentionCharacter:"@",blotName:R.atMentionBlotClass.class,initialize:function(t,e){o.addClass(R.atMentionContainerClass.class).hide();a.userSuggestionsComponent=t.createUserSuggestions(o.get(0),function(t){e({displayName:t.displayName,email:t.email,hoverContainer:a.$mentionsHoverContainer,personCardComponent:a.personCardComponent})})},hideSuggestions:function(){return o.hide(),a.userSuggestionsComponent.hideSuggestions()},renderSuggestions:function(t,e,i){o.css({left:e,top:i}).show(),a.userSuggestionsComponent.showSuggestions(t)},pickSuggestion:function(){return a.userSuggestionsComponent.pickSuggestion()},navigateSuggestions:function(t){return a.userSuggestionsComponent.navigateSuggestions(t)}}),c.formats.push(R.atMentionBlotClass.class),c.modules.keyboard.bindings.enter={handler:d=function(){for(var t=!0,e=0,i=h;e<i.length;e++)t=i[e].pickSuggestion();return t},key:13},c.modules.keyboard.bindings.tab={handler:d,key:9}),_.isEmpty(h)||(c.modules.mention={save:function(){return a.saveState()},mentions:h,maxSearchLength:T.mentionDefaultMaxSearchLength,componentFactory:this.host.getUIComponentFactory()},this.registerMentionModule()),u&&(c.formats.push(R.smartNarrativesBlotClass.class),c.formats.push(R.smartNarrativesConditionalBlotClass.class),c.formats.push(R.smartNarrativesFocusFormatAttributeName)),C.buildToolbarLinkInputTemplate(this.localizationProvider)),d=b.LinkInput.buildNode(d);this.readOnly||(e=this.toolbar,this.toolbar?e.updateOptions(this.options):((n=(e=this.toolbar=new b(this,this.localizationProvider,d,this.options)).getElement()).addClass("unselectable"),n.toggleClass("high-contrast",this.style.isHighContrast),c.modules.toolbar={container:n.get(0)}),p.attr("drag-resize-disabled","true")),this.destroyEditor(),this.destroyEditorActions=[],u&&(this.setUpSmartNarrativesFormat(),this.setUpSmartNarrativesConditionalFormat(),this.setUpSmartNarrativesFocusFormat()),this.editor=new this.quillStatic(p.get(0),c),this.readOnly||(i=new b.LinkInput(d,this.editor,this.quillStatic),n=this.toolbar.getElement(),r=new b.ColorPicker({quill:this.editor,hostServices:this.host,$colorSwatch:n.find(b.ColorPicker.colorSwatchGlyphClassAndSelector.selector),$colorPickerButton:n.find(b.ColorPicker.pickerButtonClassAndSelector.selector),$colorPickerButtonWrapper:n.find(b.ColorPicker.pickerButtonWrapperClassAndSelector.selector),defaultColor:T.ColorHelper.getThemeColor(this.style,T.ForegroundColorName),format:"color"}),R.setUpFontFormat(this.quillStatic),(s=this.editor.getModule("toolbar")).addHandler("link",function(t){t?(a.editor.setSelection(a.getSelectionAtCursor()),i.open()):i.remove()}),s.addHandler("color",function(){return r.applyFormat(r.getColor())}),this.destroyEditorActions.push(function(){s.addHandler("link",void 0),s.addHandler("color",void 0)}),u&&this.host.getUIComponentFactory()&&(this.smartNarrativesEditorContainer=new b.SmartNarrativesEditor({container:this.toolbar.getElement(),destroyEditorActions:this.destroyEditorActions,evaluatedValues:this.options.evaluatedValues,hostServices:this.host,localizationProvider:this.localizationProvider,onEditSmartNarrativePersist:this.textChanged,quill:this.editor,style:this.style,toolbar:this.toolbar}),this.smartNarrativesEditorContainer.getSmartNarrativesEditor()),this.supportsFormattingChangeIndication&&(this.formattingSettingsContainer=new b.FormattingSettings({container:this.toolbar.getElement(),hostServices:this.host}),this.formattingSettingsContainer.getTextboxFormattingSettings()),this.updateToolbar()),this.$container.append(p),this.$mentionsHoverContainer&&this.$container.append(this.$mentionsHoverContainer),o&&this.$container.append(o),l&&this.setContents(l),u||this.supportsFormattingChangeIndication?this.editor.keyboard.addBinding({key:83,shiftKey:!0,shortKey:!0},void 0,function(){a.saveState()}):this.throttleTextChanged(),this.supportsFormattingChangeIndication&&null!=(e=this.formattingSettingsContainer.getTextboxFormattingSettings())&&e.shouldListenToTextChanged()&&this.throttleTextChanged();this.editor.root.addEventListener("blur",t,!1),this.destroyEditorActions.push(function(){a.editor.root.removeEventListener("blur",t,!1)})},R.prototype.throttleTextChanged=function(){function t(t,e,i){if("api"!==i){for(var o=0,n=t.ops;o<n.length;o++){var r=n[o];if(R.isInsertOp(r)){r=r.insert;if(r&&w.containsWhitespace(r))return s.onTextChanged(),void a.cancel()}}a()}}var e,s=this,a=_.debounce(function(){return s.onTextChanged()},null!=(e=this.options.textChangeThrottle)?e:R.textChangeThrottle);this.editor.on("text-change",t),this.destroyEditorActions.push(function(){s.editor.off("text-change",t)}),this.onPaste&&this.$container.on("paste",function(){return setTimeout(function(){return s.onPaste()},0)})},R.setUpFontFormat=function(t){var i=t.import("parchment"),o=t.import(R.getFormatPath("font"));o.value=function(t){var e=R.camelize(o.keyName);return _.escape(T.Font.normalizeFamily(t.style[e]))},o.canAdd=function(t,e){return null!=i.query(t,i.Scope.BLOT&(o.scope|i.Scope.TYPE))&&(null==o.whitelist||-1<o.whitelist.indexOf(T.Font.normalizeFamily(_.unescape(e))))},o.add=function(t,e){if(!o.canAdd(t,e))return!1;var i=R.camelize(o.keyName),e=T.Font.normalizeFamily(_.unescape(e));return t.style[i]=e,!0}},R.prototype.isFormatRegisteredWithQuill=function(t){this.quillStatic;var e=this.quillStatic.imports;return!_.isEmpty(e)&&!!e[R.getFormatPath(t)]},R.prototype.setUpSmartNarrativesFormat=function(){var t,s;function e(){return null!==s&&s.apply(this,arguments)||this}this.isFormatRegisteredWithQuill(R.smartNarrativesBlotClass.class)||(t=this.quillStatic.import("blots/embed"),__extends(e,s=t),e.create=function(t){var e,i,o,n=s.create.call(this,t.objRef),r=T.ColorHelper.getDataColorByIndex(t.style,0);return t.objRef===y.QuillPlaceholder?(e=this.placeholderText,i=R.computeTransparentSmartNarrativesColor(r),$(n).addClass(R.smartNarrativesPlaceholderClass.class).css("background-color",i)):(e=T.TextEvaluation.getTextRunValueFormatted(t.objRef,t.evaluatedValues)||"",o=""+m.pointerDownEventName+R.smartNarrativesBlotClass.selector,t.destroyEditorActions&&($(n).on(o,function(){t.onSelectSmartNarrativesBlot(t.objRef)}),t.destroyEditorActions.push(function(){$(n).off(o)}))),$(n).attr(R.smartNarrativesBlotClass.class,t.objRef).attr(m.contentEditableAttribute,"false").css("border-bottom","1px solid "+r).data(R.smartNarrativesBlotClass.class,t),e?$(n).text(e):R.appendHiddenSmartNarrativesDisplay(n,t.localizationProvider.get("Visual_SmartNarratives_TextBox_Hidden")),n},e.value=function(t){return $(t).data(R.smartNarrativesBlotClass.class)},e.blotName=R.smartNarrativesBlotClass.class,e.className=R.smartNarrativesBlotClass.class,e.placeholderText="                ",e.tagName="span",this.quillStatic.register(e))},R.prototype.setUpSmartNarrativesConditionalFormat=function(){var t,o;function e(){return null!==o&&o.apply(this,arguments)||this}this.isFormatRegisteredWithQuill(R.smartNarrativesConditionalBlotClass.class)||(t=this.quillStatic.import("blots/embed"),__extends(e,o=t),e.create=function(n){if(T.TextEvaluation.isTextRunConditional(n.definition)){for(var r=o.create.call(this,n.objRef),s=""+m.pointerDownEventName+R.smartNarrativesConditionalBlotClass.selector,a=($(r).attr(R.smartNarrativesConditionalBlotClass.class,n.objRef).attr(m.contentEditableAttribute,"false").data(R.smartNarrativesConditionalBlotClass.class,n),!1),t=T.TextEvaluation.evaluateTextRunConditional(n.definition,n.evaluatedValues),l=T.ColorHelper.getDataColorByIndex(n.style,0),e=0,i=t;e<i.length;e++)!function(t){var e=$("<span>");if(N(t.value)){var i=t.value.selector.id,o=T.TextEvaluation.getTextRunValueFormatted(i,n.evaluatedValues);if(!o)return;e.addClass(R.smartNarrativesBlotClass.class).css("border-bottom","1px solid "+l).text(o),n.destroyEditorActions&&(e.on(s,function(){n.onSelectSmartNarrativesBlot(i)}),n.destroyEditorActions.push(function(){e.off(s)}))}else t.value===T.TextRunNewlineHidden?(e.text(T.TextRunNewline),a=!0):e.text(t.value);$(r).append(e)}(i[e]);return 0===r.childElementCount?R.appendHiddenSmartNarrativesDisplay(r,n.localizationProvider.get("Visual_SmartNarratives_TextBox_Hidden")):r.innerText===T.TextRunNewline&&($(r).addClass(R.smartNarrativesNewlineClass.class).attr(m.contentEditableAttribute,"true").empty().text(T.TextRunNewline),a&&$(r).addClass(R.smartNarrativesHiddenClass.class)),n.destroyEditorActions&&($(r).on(s,function(){n.onSelectSmartNarrativesConditionalBlot(n.conditionalIndex)}),n.destroyEditorActions.push(function(){$(r).off(s)})),r}},e.value=function(t){return $(t).data(R.smartNarrativesConditionalBlotClass.class)},e.blotName=R.smartNarrativesConditionalBlotClass.class,e.className=R.smartNarrativesConditionalBlotClass.class,e.tagName="span",this.quillStatic.register(e))},R.prototype.setUpSmartNarrativesFocusFormat=function(){var t,e,i=R.getFormatPath(R.smartNarrativesFocusFormatAttributeName);this.isFormatRegisteredWithQuill(i)||((e=this.quillStatic.import(R.getFormatPath("background"))).attrName=R.smartNarrativesFocusFormatAttributeName,this.quillStatic.register(((t={})[i]=e,t)))},R.prototype.setupAtMentionFormat=function(){var t,o;function n(){return null!==o&&o.apply(this,arguments)||this}this.isFormatRegisteredWithQuill(R.atMentionBlotClass.class)||(t=this.quillStatic.import("blots/embed"),__extends(n,o=t),n.create=function(i){var t,e=o.create.call(this,i.email);return $(e).attr(R.atMentionBlotClass.class,i.email).attr(m.contentEditableAttribute,"false").data(R.atMentionBlotClass.class,i).on(m.pointerOverEventName,function(){i.personCardComponent.showUser(i.email);var t=e.getBoundingClientRect();i.hoverContainer.stop(!0,!0).css({left:e.offsetLeft,top:e.offsetTop-t.height-n.topPaddingOffset}).delay(200).queue(function(t){$(e).is(":hover")&&i.hoverContainer.fadeIn("fast"),t()})}).on(m.pointerOutEventName,function(){i.hoverContainer.delay(500).queue(function(t){function e(t){i.hoverContainer.is(":hover")?setTimeout(function(){return e(t)},500):t()}e(t)}).fadeOut("fast")}).css("color","#1453b3").text(null!==(t="@"+i.displayName)?t:i.email),e},n.value=function(t){return $(t).data(R.atMentionBlotClass.class)},n.blotName=R.atMentionBlotClass.class,n.className=R.atMentionBlotClass.class,n.tagName="span",n.topPaddingOffset=24,this.quillStatic.register(n))},R.prototype.registerMentionModule=function(){function u(t,i){for(var o=this,e=(this.options=i,this.quill=t,_.isEmpty(i.mentions),t.on("text-change",function(t,e,i){return o.onTextChange(t,e,i)}),0),n=i.mentions;e<n.length;e++)!function(e){e.mentionCharacter.length,e.initialize(i.componentFactory,function(t){return o.insertBlot(e.blotName,t)})}(n[e]);this.addKeyBindings()}this.quillStatic.imports["modules/mention"]||(u.prototype.addKeyBindings=function(){function t(t){for(var e=!0,i=0,o=n.options.mentions;i<o.length;i++)e=o[i].navigateSuggestions(t);return e}var n=this;this.quill.keyboard.addBinding({key:40},void 0,function(){return t(0)}),this.quill.keyboard.addBinding({key:38},void 0,function(){return t(1)});this.quill.keyboard.addBinding({key:27},void 0,function(){for(var t=!0,e=0,i=n.options.mentions;e<i.length;e++)t=i[e].hideSuggestions();return t})},u.prototype.onTextChange=function(t,e,i){if("user"===i){this.insertPosition=void 0,this.currentPosition=void 0;i=this.quill.getSelection();if(i){this.currentPosition=i.index;var i=Math.max(0,this.currentPosition-this.options.maxSearchLength),i=this.quill.getText(i,this.currentPosition-i),o=this.getMentionConfig(i),n=o.mentionConfig,o=o.mentionCharacterPosition;if(n){for(var i=i.substring(o+1),r=0,s=this.options.mentions;r<s.length;r++){var a=s[r];a!==n&&a.hideSuggestions()}this.insertPosition=this.currentPosition-i.length-1;var o=this.quill.getBounds(this.insertPosition),l=this.quill.root.getBoundingClientRect(),l=Math.min(o.left,l.width-u.SuggestionWidth),o=o.height+o.bottom;n.renderSuggestions(i,l,o)}else this.hideAllSuggestions()}}},u.prototype.getMentionConfig=function(t){for(var e=0,i=this.options.mentions;e<i.length;e++){var o=i[e],n=t.lastIndexOf(o.mentionCharacter);if(-1!==n)return{mentionConfig:o,mentionCharacterPosition:n}}return{mentionConfig:void 0,mentionCharacterPosition:-1}},u.prototype.insertBlot=function(t,e){this.hideAllSuggestions(),_.isNil(this.insertPosition)||_.isNil(this.currentPosition)||(this.quill.deleteText(this.insertPosition,this.currentPosition-this.insertPosition,"api"),this.quill.insertEmbed(this.insertPosition,t,e,"api"),this.quill.setSelection(this.insertPosition+1,0,"api"),this.options.save())},u.prototype.hideAllSuggestions=function(){for(var t=0,e=this.options.mentions;t<e.length;t++)e[t].hideSuggestions()},u.SuggestionWidth=200,this.quillStatic.register("modules/mention",u))},R.willBrowserHandleFocus=function(t){return"SELECT"===t.tagName||"INPUT"===t.tagName||!!t.getAttribute("contentEditable")},R.prototype.targetIsInToolbar=function(t,e){return!!this.toolbar&&(!("A"!==t.tagName&&"BUTTON"!==t.tagName&&!e)&&(e=$(t),(t=this.toolbar.getElement()).is(":visible")&&(e.is(t)||0<e.closest(t).length)))},R.prototype.onTextChanged=function(){var t;this.textChanged(),this.supportsFormattingChangeIndication&&null!=(t=this.formattingSettingsContainer.getTextboxFormattingSettings())&&t.onTextChanged()},R.prototype.saveState=function(){var t;null!=(t=null==(t=this.editor)?void 0:t.history)&&t.clear(),this.onTextChanged()},R.isInsertOp=function(t){return null!=t.insert},R.camelize=function(t){var t=t.split("-"),e=_.map(t.slice(1),function(t){return t[0].toUpperCase()+t.slice(1)}).join("");return t[0]+e},R.prototype.focusToolbar=function(){if(!this.editor||!this.toolbar)return!1;l.focusChildInGroup(this.toolbar.getElement().get(0))},R.appendHiddenSmartNarrativesDisplay=function(t,e){var i=$("<span>"),o=$("<span>"),n=$("<span>");i.text("["),o.addClass("glyphicon glyph-mini pbi-glyph-hide3"),n.text("]"),$(t).addClass(R.smartNarrativesHiddenClass.class).append(i,o,n).attr("title",e)},R.prototype.updateToolbar=function(){var t;this.toolbar&&(t=null==(t=this.options)?void 0:t.supportsNarrativeExpressions,this.host.setToolbar(this.toolbar.getElement(),{preferHorizontalLayout:t,theme:t?"neutralGrayTheme":"darkTheme"}))},R.quillFormatsPath="formats",R.atMentionBlotClass=s("at-mention"),R.atMentionContainerClass=s("mentions-container"),R.smartNarrativesBlotClass=s("smart-narratives-blot"),R.smartNarrativesConditionalBlotClass=s("smart-narratives-conditional-blot"),R.smartNarrativesFocusFormatAttributeName="smartNarrativesFocus",R.smartNarrativesHiddenClass=s("smart-narratives-hidden"),R.smartNarrativesNewlineClass=s("smart-narratives-newline"),R.smartNarrativesPlaceholderClass=s("placeholder"),R.smartNarrativesPlaceholderOpacity=.2,R.textChangeThrottle=600,S=R,y.QuillWrapper=S,B.prototype.getElement=function(){return this.container},B.prototype.updateOptions=function(t){var e=t.defaultFont;this.onEscape=t.onEscape,this.updateFontFamilyUI(e,t.fontFamilies),this.updateFontSizeUI(e,t.fontSizes),this.updateTextAlignmentUI(),this.featureSwitches&&this.featureSwitches.textboxSuperSubScriptBulletedList&&this.updateTextScriptUI()},B.prototype.updateFontSizeUI=function(t,e){var i=S.getFormatPath("size");this.updateStyleAllowList(this.quillWrapper.quillStatic,"size",null,i,!0),this.fontSizes=_.map(e,function(t){return{label:""+t,value:t+"pt"}}),this.defaultFontSize=t.size.pt+"pt",this.fontSizePicker?C.updatePicker(this.fontSizePicker,this.fontSizes,this.defaultFontSize):this.fontSizePicker=C.picker(C.getTooltip("Size",this.localizationProvider),this.fontSizes,"size",this.defaultFontSize)},B.prototype.updateFontFamilyUI=function(t,e){var i=e.map(function(t){return T.Font.normalizeFamily(F.getCSSFromFont(t))}),o=S.getFormatPath("font");this.updateStyleAllowList(this.quillWrapper.quillStatic,"font",i,o,!0),this.fontFamilies=_.map(e,function(t){return{label:t,value:_.escape(T.Font.normalizeFamily(F.getCSSFromFont(t)))}}),this.defaultFontFamily=_.escape(T.Font.normalizeFamily(F.getCSSFromFont(t.family))),this.fontFamilyPicker?C.updatePicker(this.fontFamilyPicker,this.fontFamilies,this.defaultFontFamily):this.fontFamilyPicker=C.picker(C.getTooltip("Font",this.localizationProvider),this.fontFamilies,"font",this.defaultFontFamily,function(t,e){return t.css("font-family",e.value),t})},B.prototype.updateTextAlignmentUI=function(){var i=this.defaultTextAlignment=F.DefaultAlignment,t=(this.textAlignments=_.map(F.TextAlignments,function(t){var e=t.toLowerCase();return{label:t,value:t===i?"":e,glyph:"align"+e}}),_.map(this.textAlignments,function(t){return t.value})),e=S.getFormatPath("align");this.updateAllowList(this.quillWrapper.quillStatic,e,t),this.textAlignmentGroup||(this.textAlignmentGroup=C.toggleGroup("Text Alignment",this.textAlignments,"align",this.defaultTextAlignment,this.localizationProvider,!1))},B.prototype.updateTextScriptUI=function(){this.textScripts=_.map(F.TextScriptTypes,function(t){var e=t.toLowerCase();return{label:t,value:e,glyph:e+"script"}});var t=_.map(this.textScripts,function(t){return t.value}),e=S.getFormatPath("script");this.updateAllowList(this.quillWrapper.quillStatic,e,t),this.textScriptGroup||(this.textScriptGroup=C.toggleGroup("Script",this.textScripts,"script","",this.localizationProvider,!0))},B.prototype.updateStyleAllowList=function(t,e,i,o,n){this.updateAllowList(t,"attributors/style/"+e,i,o,n=void 0===n?!1:n)},B.prototype.updateAllowList=function(t,e,i,o,n){void 0===n&&(n=!1);var r=t.import(e);r.whitelist=i,t.register(o||e,r,n)},b=B,y.Toolbar=b,(x=C=y.ToolbarBuilder||(y.ToolbarBuilder={})).buildToolbarLinkInputTemplate=function(t){var e=k(),i=t.get("RichTextbox_Link_Done"),o=t.get("RichTextbox_Link_Remove"),n=t.get("RichTextbox_Link_Edit"),t=M("Link",t);return e.append($('\n                        <a href="#" class="ql-preview" target="_blank"></a>\n                        <input class="input" type="text" aria-label="'+t+'">\n                        <span class="bar">&nbsp;|&nbsp;</span>\n                        <button class="ql-action ql-save">'+i+'</button>\n                        <button class="ql-action ql-edit">'+n+'</button>\n                        <button class="ql-remove">'+o+"</button>\n                    ")),e.html()},x.formatGroup=function(){return I().addClass("ql-formats")},x.smartNarrativesEditor=function(){return k().addClass(x.smartNarrativesEditorClass.class)},x.formattingSettingsGroup=function(){return k().addClass(x.formattingSettingsClass.class)},x.div=k,x.span=I,x.button=L,x.toggleGroup=function(t,e,i,o,n,r){return e.map(function(t){var e=null!=t.glyph?t.glyph:i+t.value;return j(M(t.label,n),i,t.value,e,r)})},x.picker=function(t,e,i,o,n){return U(t,e,o,n).addClass("ql-"+i+" ql-picker")},x.updatePicker=W,x.selector=U,x.updateSelector=W,x.options=q,x.formatButton=j,x.getTooltip=M,x.smartNarrativesEditorClass=s("smart-narratives-editor"),x.formattingSettingsClass=s("formatting-settings"),function(t){function n(t,i,e){var o=this;this.$container=t,this.quill=i,this.quillStatic=e,this.$preview=this.$container.find("a.ql-preview"),this.$textbox=this.$container.find("input[type=text]"),this.textbox=this.$textbox[0],this.$action=this.$container.find(".ql-action"),this.hide(),this.$textbox.on("keydown",function(t){13===t.keyCode?o.onSave(t):27===t.keyCode&&o.onHide(t)}),["click","touchstart"].forEach(function(t){o.$action.on(t,function(t){o.$container.hasClass(n.editingClass)?o.onSave(t):o.onEdit(t)}),o.$container.find(".ql-remove").on(t,function(t){return o.onRemove(t)})}),i.on("selection-change",function(t){if(null!=t||!o.isEditing){if(null!=t&&0===t.length){var e=i.scroll.descendant(o.quillStatic.import(S.getFormatPath("link")),t.index);if(o.link=e[0],e=e[1],null!=o.link)return e={index:t.index-e,length:o.link.length()},void(_.isEqual(o.range,e)||(o.range=e,o.show()));0<t.index&&i.scroll.descendant(o.quillStatic.import(S.getFormatPath("link")),t.index-1)[0]&&setTimeout(function(){return o.quill.format("link",!1)})}o.hide()}})}function r(t){var e=this;this.quill=t.quill,this.hostServices=t.hostServices,this.$colorSwatch=t.$colorSwatch,this.$colorPickerButtonWrapper=t.$colorPickerButtonWrapper,this.defaultColor=t.defaultColor,this.format=t.format,this.currentColor=t.defaultColor,this.setSwatch(this.currentColor),t.$colorPickerButton.on("click",function(t){t.stopPropagation(),e.toggle()})}function e(t){this.container=t.container,this.destroyEditorActions=t.destroyEditorActions,this.evaluatedValues=t.evaluatedValues,this.hostServices=t.hostServices,this.localizationProvider=t.localizationProvider,this.onEditSmartNarrativePersist=t.onEditSmartNarrativePersist,this.quill=t.quill,this.style=t.style,this.toolbar=t.toolbar,this.container,this.destroyEditorActions,this.evaluatedValues,this.hostServices,this.localizationProvider,this.onEditSmartNarrativePersist,this.quill,this.style,this.toolbar;t=T.ColorHelper.getDataColorByIndex(t.style,0);this.focusColor=y.QuillWrapper.computeTransparentSmartNarrativesColor(t)}function i(t){this.container=t.container,this.hostServices=t.hostServices,this.container,this.hostServices}n.buildNode=function(t){return C.div().addClass(h.toolbarUrlInput.class).append($(t))},n.prototype.onHide=function(t){this.hide(),this.stopEvent(t)},n.prototype.onSave=function(t){this.save(),this.stopEvent(t)},n.prototype.onEdit=function(t){this.edit(),this.stopEvent(t)},n.prototype.onRemove=function(t){this.remove(),this.stopEvent(t)},n.prototype.stopEvent=function(t){t.stopPropagation(),t.preventDefault()},n.prototype.edit=function(){this.isEditing=!0,this.$container.addClass(n.editingClass),this.$textbox.focus(),this.textbox.setSelectionRange(0,this.textbox.value.length)},n.prototype.open=function(){this.range=this.quill.getSelection(),this.show(),this.edit()},n.prototype.hide=function(){this.range=this.link=null,this.$container.hide(),this.isEditing=!1},n.prototype.remove=function(){this.range=this.range||this.quill.getSelection(),this.quill.formatText(this.range,"link",!1,"user"),this.quill.setSelection(this.range,"silent"),this.hide()},n.prototype.save=function(){var t=this.range,e=this.textbox.value;0===t.length&&(this.quill.insertText(this.range.index,e),this.quill.setSelection(this.range.index,e.length),t=this.range=this.quill.getSelection()),this.quill.formatText(t.index,t.length,"link",e,"user"),this.quill.setSelection(t,"silent"),this.link=this.quill.scroll.descendant(this.quillStatic.import(S.getFormatPath("link")),t.index)[0],this.show()},n.prototype.show=function(){this.isEditing=!1,this.$container.removeClass(n.editingClass),this.$container.show();var t=this.range=this.range||this.quill.getSelection(),e=null!=this.link?this.link.formats().link:(e=this.quill.getText(t.index,t.length),o.LinkPreview.format(e));this.$textbox.val(e),this.$preview.text(e),this.$preview.attr("href",e)},n.editingClass="ql-editing",t.LinkInput=n,r.buildFontColorButtons=function(t,e){var i=$("<span></span>").addClass("powervisuals-glyph").addClass(r.colorGlyphClassAndSelector.class),o=$("<span></span>").addClass("powervisuals-glyph").addClass(r.colorSwatchGlyphClassAndSelector.class),t=$("<button>").addClass("ql-color").addClass(r.colorButtonClassAndSelector.class).attr("title",t).attr("aria-label",t).val("false").append(i).append(o),i=$("<button>").addClass("colorpicker powervisuals-glyph chevrondown").addClass(r.pickerButtonClassAndSelector.class).attr("title",e).attr("aria-label",e).val("false");return[t,$("<div>").addClass(r.pickerButtonWrapperClassAndSelector.class).append(i)]},r.prototype.onColorChange=function(t){this.currentColor.toUpperCase()!==t.toUpperCase()&&(this.setSwatch(t||this.defaultColor),this.applyFormat(t||null,this.range),this.currentColor=t)},r.prototype.onClose=function(){var t=this.ensureRange();this.quill.setSelection(t.index,t.length),this.color?this.quill.format(this.format,this.color,"user"):this.quill.format(this.format,!1,"user")},r.prototype.getColor=function(){return this.currentColor},r.prototype.applyFormat=function(t,e){e=this.ensureRange(e);(this.color=t)&&t!==this.defaultColor?(this.quill.formatText(e.index,e.length,this.format,t,"user"),this.quill.format(this.format,this.color,"user")):(this.quill.formatText(e.index,e.length,this.format,!1,"user"),this.quill.format(this.format,!1,"user"))},r.prototype.toggle=function(){this.range=this.ensureRange(),this.getColorPicker().toggle()},r.prototype.getColorPicker=function(){var e=this,t=this.$colorPickerButtonWrapper.get(0);return this.colorPicker=this.hostServices.getUIComponentFactory().createColorPicker(t.firstChild,{value:this.getRangeColor()},function(t){return e.onColorChange(t&&t.value)},function(){return e.onClose()}),this.colorPicker},r.prototype.getRangeColor=function(){var t=this.quill.getSelection();if(!t)return this.defaultColor;t=this.quill.getFormat(t.index,t.length);return"string"==typeof(null==t?void 0:t.color)?t.color:this.defaultColor},r.prototype.setSwatch=function(t){this.$colorSwatch.get(0).style.setProperty("color",t,"important")},r.prototype.ensureRange=function(t){return this.quill.focus(),t||this.quill.getSelection()||{index:0,length:0}},r.colorGlyphClassAndSelector=s("fontcolor"),r.colorSwatchGlyphClassAndSelector=s("fontcolorswatch"),r.colorButtonClassAndSelector=s("fontcolorbutton"),r.pickerButtonClassAndSelector=s("fontcolorpicker"),r.pickerButtonWrapperClassAndSelector=s("fontcolorbutton-wrapper"),t.ColorPicker=r,e.prototype.getSmartNarrativesEditor=function(){var i=this;return this.component=this.component||this.hostServices.getUIComponentFactory().createSmartNarrativesEditor(this.container.find(C.smartNarrativesEditorClass.selector).get(0),T.textboxProps.values.expr,{onEditSmartNarrativeCancel:function(){return i.onEditSmartNarrativeCancel()},onEditSmartNarrativeFinish:function(t,e){return i.onEditSmartNarrativeFinish(t,e)},onEditSmartNarrativeStart:function(){return i.onEditSmartNarrativeStart()},onSmartNarrativeFocusChange:function(t,e){return i.onSmartNarrativeFocusChange(t,e)},onUpdateToolbar:function(){return i.onUpdateToolbar()},onEscape:function(){return i.focusOnToolbar()}}),this.component},e.prototype.onGetSmartNarrativesBlot=function(e){var i={index:-1,op:void 0},t=this.quill.getContents();return t&&(i.op=_.find(t.ops,function(t){return!!t&&(_.isString(t.insert)?(i.index+=t.insert.length,!1):_.isNumber(t.insert)?(i.index+=1,!1):(t=y.getCustomQuillFormatValue(t,y.QuillWrapper.smartNarrativesBlotClass.class),i.index+=1,(null==t?void 0:t.objRef)===e))})),i},e.prototype.onEditSmartNarrativeCancel=function(){var t=-1,e=this.onGetSmartNarrativesBlot(y.QuillPlaceholder);return e&&0<=e.index&&e.op&&(this.quill.removeFormat(e.index,1),t=e.index,this.quill.setSelection(t,0,"api")),t},e.prototype.onEditSmartNarrativeFinish=function(i,t){var o=this,e=this.onEditSmartNarrativeCancel();t?this.applyObjRefUpdate(t,function(t){var e=o.quill.getFormat(t);o.quill.removeFormat(t,1),o.insertSmartNarrativesBlot(i,t),o.quill.formatText(t,1,e,"api")}):(e<0&&(e=this.getInsertionIndex()),this.insertSmartNarrativesBlot(i,e)),this.onEditSmartNarrativePersist()},e.prototype.onEditSmartNarrativeStart=function(){this.onEditSmartNarrativeCancel();var t=this.getInsertionIndex();this.insertSmartNarrativesBlot(y.QuillPlaceholder,t)},e.prototype.onSmartNarrativeFocusChange=function(t,i){var o=this;this.applyObjRefUpdate(t,function(t){var e=o.quill.getFormat(t,1);e.smartNarrativesFocus=i?o.focusColor:void 0,o.quill.formatText(t,1,e,"api")})},e.prototype.updateOptions=function(t){this.evaluatedValues=t.evaluatedValues},e.prototype.applyObjRefUpdate=function(t,e){var i=this.quill.getContents();if(i)for(var o=-1,n=0,r=i.ops;n<r.length;n++){var s=r[n];if(!s)return;_.isString(s.insert)?o+=s.insert.length:_.isNumber(s.insert)?o+=1:(o+=1,(null==(s=y.getCustomQuillFormatValue(s,y.QuillWrapper.smartNarrativesBlotClass.class))?void 0:s.objRef)===t&&e(o))}},e.prototype.getInsertionIndex=function(){var t=this.quill.getSelection(!0);return t?t.index:0},e.prototype.insertSmartNarrativesBlot=function(t,e){var i=this,t={destroyEditorActions:this.destroyEditorActions,evaluatedValues:this.evaluatedValues,localizationProvider:this.localizationProvider,objRef:t,onSelectSmartNarrativesBlot:function(t){i.getSmartNarrativesEditor().onSelectEditableObject(t)},style:this.style};this.quill.insertEmbed(e,S.smartNarrativesBlotClass.class,t,"api"),this.quill.setSelection(e+1,0,"api")},e.prototype.onUpdateToolbar=function(){this.hostServices.setToolbar(this.toolbar.getElement(),{preferHorizontalLayout:!0,theme:"neutralGrayTheme"})},e.prototype.focusOnToolbar=function(){this.toolbar&&l.focusChildInGroup(this.toolbar.getElement().get(0))},t.SmartNarrativesEditor=e,i.prototype.getTextboxFormattingSettings=function(){var t;return this.component=this.component||(null==(t=this.hostServices.getUIComponentFactory())?void 0:t.createTextboxFormattingSettings(this.container.find(C.formattingSettingsClass.selector).get(0))),this.component},t.FormattingSettings=i}(b=y.Toolbar||(y.Toolbar={}))}(powerbi=powerbi||{}),define("TextboxVisual/textboxModule",["require","exports"],function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.createAlwaysUseSmallViewportTextboxViewModelAdapter=e.createTextboxViewModelAdapter=e.createTextbox=void 0,e.createTextbox=function(t){return new powerbi.visuals.Textbox(t)},e.createTextboxViewModelAdapter=function(t){return new powerbi.visuals.TextboxHelpers.ViewModelAdapter(t)},e.createAlwaysUseSmallViewportTextboxViewModelAdapter=function(){return new powerbi.visuals.TextboxHelpers.AlwaysUseSmallViewport}}),function(t){((t=t.powerbi||(t.powerbi={})).visuals||(t.visuals={})).importTextboxModule=function(){}}(es6=es6||{}),function(t){var e;(e=t.visuals||(t.visuals={})).initializeTextboxVisualFactoryES6=function(){e.setCreateTextbox(function(e){return es6.powerbi.visuals.importTextboxModule().then(function(t){return t.createTextbox(e)})}),e.setCreateTextboxViewModelAdapter(function(e){return es6.powerbi.visuals.importTextboxModule().then(function(t){return t.createTextboxViewModelAdapter(e)})}),e.setCreateAlwaysUseSmallViewportTextboxViewModelAdapter(function(){return es6.powerbi.visuals.importTextboxModule().then(function(t){return t.createAlwaysUseSmallViewportTextboxViewModelAdapter()})})}}(powerbi=powerbi||{});
this.parseTimeMarkers = this.parseTimeMarkers || {};
var marker = this.parseTimeMarkers['textboxVisual.min.js'] || (this.parseTimeMarkers['textboxVisual.min.js'] = {});
marker.endEval = window.jsCommon && window.jsCommon.performance && window.jsCommon.performance.now ? window.jsCommon.performance.now() : Date.now(); marker.isExternal = false;
